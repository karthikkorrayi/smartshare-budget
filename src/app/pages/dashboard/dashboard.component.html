<div class="dashboard" [class.loading]="isLoading">

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Loading month data...</p>
  </div>

  <!-- LEFT COLUMN -->
  <div class="left-column">

    <!-- Greeting Card -->
    <mat-card class="card greeting-card greeting-modern">

    <!-- Header -->
    <div class="greeting-header">
      <div>
        <h4 class="greet-text">Hello üëã</h4>
        <h1 class="username">{{ username }}</h1>
        <p class="date-text">
          {{ today | date: 'dd MMMM, EEEE' }}
        </p>
      </div>

      <div class="month-select">
        <label>Month</label>
        <select [(ngModel)]="selectedMonth" (change)="onMonthChange()">
          <option *ngFor="let m of months" [value]="m.value">
            {{ m.label }}
          </option>
        </select>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-info">
        <span class="progress-label">
          {{ completionPercent }}% completed
        </span>
        <span class="remaining" *ngIf="completionPercent < 100">
          {{ remainingDays }} days left
        </span>
      </div>

      <mat-progress-bar
        mode="determinate"
        [value]="completionPercent">
      </mat-progress-bar>
    </div>

  </mat-card>

    <!-- Category Gauge -->
    <mat-card class="card receivable-card">

      <!-- Header -->
      <div class="receivable-header">
        <h3>Amount to Receive</h3>
        <h1 class="total">‚Çπ{{ totalReceivable }}</h1>
      </div>

      <div class="divider"></div>

      <!-- Data Entry -->
      <div class="receivable-form">
        <div class="form-group">
          <label>Title</label>
          <input
            type="text"
            placeholder="Friend / Reason"
            [(ngModel)]="newReceivable.title"
          />
        </div>

        <div class="form-group amount-group">
          <label>Amount</label>
          <input
            type="number"
            placeholder="0"
            [(ngModel)]="newReceivable.amount"
          />
          <button class="add-btn" (click)="addReceivable()">+</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- List -->
      <div *ngFor="let r of receivables" class="receivable-row" [class.paid]="r.status === 'PAID'">
        <input
          type="checkbox"
          [checked]="r.status === 'PAID'"
          [disabled]="r.status === 'PAID'"
          (change)="markReceivableReceived(r)"
        />

        <div class="row-content">
          <span class="title" [class.paid-text]="r.status === 'PAID'">{{ r.title }}</span>
          <span class="row-amount" [class.paid-text]="r.status === 'PAID'">‚Çπ{{ r.amount }}</span>
        </div>

        <span class="delete" [class.disabled]="r.status === 'PAID'" (click)="deleteReceivable(r.id)">üóëÔ∏è</span>
      </div>

    </mat-card>

    <!-- Category Summary -->
   <mat-card class="card category-summary">
      <h3>Category Summary</h3>

      <div
        *ngFor="let cat of categorySummary"
        class="category-row-advanced"
      >
        <!-- Top Row -->
        <div class="category-top">
          <div class="category-left">
            <span class="category-icon">{{ cat.icon }}</span>
            <span class="category-name">{{ cat.name }}</span>
          </div>

          <div class="category-right">
            <span class="category-amount">‚Çπ{{ cat.amount }}</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="category-progress">
          <mat-progress-bar
            mode="determinate"
            [value]="cat.percentage"
          ></mat-progress-bar>

          <span class="category-percent">
            {{ cat.percentage }}%
          </span>
        </div>
      </div>
    </mat-card>

  </div>

  <!-- CENTER COLUMN -->
  <div class="center-column">
    <mat-card class="card">
      <h3>Recent Income</h3>

      <table class="spending-table-ui">
        <tr *ngFor="let inc of recentIncome" [class.system-generated]="inc.isSystemGenerated">
          <td>
            <span>{{ inc.source }}</span>
            <span class="system-badge" *ngIf="inc.isSystemGenerated">Auto</span>
          </td>
          <td>‚Çπ{{ inc.amount }}</td>
          <td>
            <span
              class="action"
              [class.disabled]="inc.isSystemGenerated"
              (click)="editIncome(inc)">‚úèÔ∏è</span>
            <span
              class="action"
              [class.disabled]="inc.isSystemGenerated"
              (click)="deleteIncome(inc.id)">üóëÔ∏è</span>
          </td>
        </tr>
      </table>
    </mat-card>

    <!-- Top Stats -->
    <div class="stats-row">
      <div class="kpi-card income" [class.active]="availableBalance > 0">
        <p class="kpi-label">Total Income</p>
        <h2 class="kpi-value">‚Çπ{{ totalIncome | number:'1.0-0' }}</h2>
      </div>

      <div class="kpi-card expense">
        <p class="kpi-label">Total Spending</p>
        <h2 class="kpi-value">‚Çπ{{ totalExpenses | number:'1.0-0' }}</h2>
      </div>

      <div class="kpi-card balance" [class.active]="availableBalance > totalIncome * 0.5">
        <p class="kpi-label">Available Balance</p>
        <h2 class="kpi-value" [class.positive]="availableBalance > 0" [class.negative]="availableBalance < 0">
          ‚Çπ{{ availableBalance | number:'1.0-0' }}
        </h2>
      </div>
    </div>


    <!-- Monthly Bar Chart -->
    <!-- Monthly Bar Chart -->
    <mat-card class="card bar-chart">
      <div class="bar-chart-header">
        <h3>{{ selectedMonthLabel }}</h3>
        <span class="subtitle">Daily spending trend</span>
      </div>

      <div class="bar-chart-wrapper">
        <canvas id="monthlyBarChart"></canvas>
      </div>
    </mat-card>

    <!-- Spending Table -->
    <mat-card class="card spending-table-modern">
      <div class="table-header">
        <h3>Spending Summary</h3>
        <span class="transaction-count" *ngIf="recentExpenses.length > 0">
          {{ recentExpenses.length }} transaction{{ recentExpenses.length > 1 ? 's' : '' }}
        </span>
      </div>

      <div class="table-container" *ngIf="recentExpenses.length > 0">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Category</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let exp of recentExpenses" class="table-row" [class.paid-row]="exp.status === 'PAID'">
              <td>
                <div class="description-cell">
                  <span class="category-icon">{{ getCategoryIcon(exp.category) }}</span>
                  <span class="description-text">{{ exp.description }}</span>
                </div>
              </td>
              <td>
                <span class="category-badge" [attr.data-category]="exp.category.toLowerCase()">
                  {{ exp.category }}
                </span>
              </td>
              <td>
                <span class="date-text">{{ exp.date.toDate() | date:'dd MMM yyyy' }}</span>
              </td>
              <td>
                <span class="amount-text">‚Çπ{{ exp.amount | number:'1.0-0' }}</span>
              </td>
              <td>
                <span class="status-badge" *ngIf="exp.status === 'PAID'">PAID</span>
                <span class="status-badge pending" *ngIf="!exp.status || exp.status !== 'PAID'">PENDING</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="action-btn edit-btn" (click)="editExpense(exp)" title="Edit">
                    <span class="btn-icon">‚úèÔ∏è</span>
                  </button>
                  <button class="action-btn delete-btn" (click)="deleteExpense(exp.id)" title="Delete">
                    <span class="btn-icon">üóëÔ∏è</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="empty-state" *ngIf="recentExpenses.length === 0">
        <div class="empty-icon">üìä</div>
        <h4>No transactions yet</h4>
        <p>Your spending history will appear here once you add expenses</p>
      </div>
    </mat-card>

  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-column">

    <!-- Spending Fulfillment -->
    <mat-card class="card fulfillment modern-line-card">
      <div class="line-header">
        <div>
          <h3>Monthly Spending Trend</h3>
          <p class="subtitle">
            {{ selectedMonth | date:'MMMM yyyy' }} vs previous month
          </p>
        </div>
      </div>

      <div class="line-chart-wrapper">
        <canvas id="spendingLineChart"></canvas>
      </div>

      <div class="line-info modern">
        <div>
          <span class="dot this"></span>
          <span>This Month</span>
          <strong>‚Çπ{{ totalExpenses }}</strong>
        </div>
        <div>
          <span class="dot last"></span>
          <span>Last Month</span>
          <strong>‚Çπ{{ lastMonthCumulative.at(-1) || 0 }}</strong>
        </div>
      </div>
    </mat-card>

    <!-- Upcoming Payments -->
    <mat-card class="card upcoming">
      <div class="upcoming-header">
        <h3>Upcoming Payments</h3>
        <span class="calendar-icon">üìÖ</span>
      </div>

      <!-- EMPTY STATE -->
      <div *ngIf="upcomingPayments.length === 0" class="upcoming-empty">
        <div class="empty-illustration">üì≠</div>
        <p>No upcoming payments</p>
        <span>You're all clear for now</span>
      </div>

      <!-- LIST -->
      <div *ngFor="let pay of upcomingPayments" class="upcoming-item">
        <div class="left">
          <input
            type="checkbox"
            (change)="markAsPaid(pay)"
          />

          <div class="details">
            <strong>{{ pay.description }}</strong>

            <span
              class="due-badge"
              [class.urgent]="pay.dueIn <= 3"
            >
              Due in {{ pay.dueIn }} day{{ pay.dueIn > 1 ? 's' : '' }}
            </span>
          </div>
        </div>

        <div class="right">
          <span class="amount">‚Çπ{{ pay.amount }}</span>
          <span
            class="delete"
            title="Remove"
            (click)="deleteUpcoming(pay.id)"
          >
            ‚úï
          </span>
        </div>
      </div>
    </mat-card>

</div>

<div class="fab-container">
  <button class="fab" (click)="toggleFab()">+</button>

  <div class="fab-menu" *ngIf="fabOpen">
    <button class="cta-btn expense-btn" (click)="openAddExpense()">
      <span class="btn-icon">üí∏</span>
      <span class="btn-text">Add Expense</span>
    </button>
    <button class="cta-btn income-btn" (click)="openAddIncome()">
      <span class="btn-icon">üí∞</span>
      <span class="btn-text">Add Income</span>
    </button>
  </div>
</div>